<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>발주 제안</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="application/javascript" src="/js/util.js"></script>
<script src="/js/modalStoreSearch.js"></script>

<style>
    html, body {
        height:100%;
        margin:0;
        padding:0;
        overflow:hidden;
    }

    body {
        height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;

        background:#f8f9fa;
        font-family:"Noto Sans KR",sans-serif;
    }

    h3 { margin:0; padding:20px 20px 20px 20px; }

    .p-4 {
        flex: 1;               /* 헤더 제외 전체 영역 */
        display: flex;         /* 내부 배치를 안정적으로 */
        flex-direction: column;
        overflow: hidden;      /* 여기 스크롤도 제거 */
    }

    .panel {
        background:#fff;
        border-radius:12px;
        padding:20px;
        box-shadow:0 1px 4px rgba(0,0,0,0.08);
        display:flex;
        flex-direction:column;
        min-height:0;
        flex: 1;
    }

    .scroll-area {
        flex:1;
        min-height:0;
        overflow-y:auto;
        overflow-x:hidden;
        scrollbar-gutter: stable;
    }

    .table-rounded {
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        background:white;
        width:100%;
        table-layout: fixed;
    }

    .table-rounded thead {
        background:#f1f3f5;
        font-weight:600;
    }
    .table-rounded thead th{
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f1f3f5;
    }

    .table-rounded th, .table-rounded td {
        padding:14px 18px !important;
        white-space:nowrap;
    }

    .top-section {
        flex:1;
        padding:20px;
        display:flex;
        flex-direction:column;
        gap:15px;
        min-height:0;
    }
    .bottom-section {
        flex:1;
        padding:20px;
        display:flex;
        flex-direction:column;
        min-height:0;
    }
    #content-area{
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        width: 1500px;
    }
</style>
</head>

<body>
<header th:replace="fragments/toolBar :: toolBar"></header>
<div class="p-4 container"><div>
    <div class="d-flex align-items-center px-3">
        <h3 class="fw-bold m-0">발주 제안</h3>
        <div>
            <input id="storeSearchInput"
                   class="btn btn-light border dropdown-toggle"
                   type="button"
                   value="직영점 선택"
                   style="min-width:180px;">
        </div>
    </div>
</div>
<div class="card-box mb-4 container d-flex flex-column" id="content-area">
    <div class="top-section">
        <div class="panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold">발주 추천 목록</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#proposalModal" id="item_proposal_history">
                        제안 내역
                    </button>
                </div>
            </div>
            <div class="scroll-area">
                <table class="table table-rounded table-sm align-middle shadow-sm" id="item-proposal">
                    <thead>
                        <tr>
                            <th>품목명</th>
                            <th>공급단위</th>
                            <th>수량</th>
                            <th>금액</th>
                            <th>사유</th>
                            <th class="text-center">삭제</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
    
            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                <div>총 품목수: <strong><span id="total-cnt"></span><label>개</label></strong></div>
                <div>총 발주액: <strong><span id="total-price"></span><label>원</label></strong></div>
                <button class="btn btn-warning" id="proposal-btn">발주 제안</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel">
            <h5 class="fw-semibold mb-3">재고 현황</h5>

            <div class="d-flex mb-3">
                <select class="form-select me-2" style="width:150px;">
                    <option>기본순</option><option>추천순</option><option>하한선순</option>
                </select>

                <select class="form-select me-2" style="width:150px;">
                    <option>전체</option><option>도우</option><option>소스</option><option>치즈</option>
                </select>

                <input type="text" class="form-control me-2" style="width:200px;" placeholder="검색어 입력" id="search-input">
                <button class="btn btn-warning" id="search-btn">조회</button>
            </div>

            <div class="scroll-area">
                <table class="table table-rounded table-hover table-sm align-middle shadow-sm" id="item_toOrder">
                    <thead>
                        <tr>
                            <th>품목코드</th>
                            <th>품목명</th>
                            <th>카테고리</th>
                            <th>하한선</th>
                            <th>실재고</th>
                            <th>공급단위</th>
                            <th>공급가격</th>
                            <th class="text-center">담기</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

<!-- =========================
      ▣ 제안 내역 모달 영역
     ========================= -->
<div class="modal fade" id="proposalModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">본사 발주 제안 내역</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <table class="table table-bordered table-hover align-middle" id="proposal_history_table">
                    <thead>
                    <tr>
                        <th>제안 일자</th>
                        <th>품목명</th>
                        <th>제안 수량</th>
                        <th>제안 사유</th>
                        <th>요청자</th>
                        <th>응답 여부</th>
                    </tr>
                    </thead>

                    <tbody>
                    </tbody>
                </table>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>

        </div>
    </div>
</div>

<div th:replace="fragments/modalStoreSearch :: modalStoreSearch"></div>
<script>
    const itemProposal = $("#item-proposal");

    itemProposal.on("click", ".remove-btn", function(){
        $(this).closest("tr").remove();
    });

    // 수량 변경 시 발생 이벤트
    itemProposal.on("input", ".quantity-box", function (){
        const tr = $(this).closest("tr");
        const name = tr.find("td").eq(0).text().trim();
        // 품목 정보 획득
        const itemRow = $("#item_toOrder tbody tr").filter(function(){
            return $(this).find("td").eq(1).text().trim() === name;
        });

        const unitPrice = parseInt(itemRow.find("td").eq(6).data("price"));
        let qty = parseInt($(this).val());


        // 1개 이하 검사
        if (!qty || qty < 1) {
            qty = 1;
            $(this).val(1);
            alert("수량은 1개 이상이어야 합니다.");
        }

        tr.find("td").eq(3)
            .text((unitPrice * qty).toLocaleString() + "원")
            .data("price", unitPrice * qty);

        calcTotal();
    });

    // 담기 버튼 이벤트
    $(document).on("click", "#item_toOrder .add_btn", function(){
        const itemRow = $(this).closest("tr");
        const itemName = itemRow.find("td").eq(1).text();

        if (hasDuplicate(itemName)) {
            alert("이미 선택된 품목입니다.");
            return;
        }

        const newRow = $("<tr>").data("itemno", itemRow.data("itemno"));
        $("<td>").text(itemName).appendTo(newRow); // 품목 명
        $("<td>").text(itemRow.find("td").eq(5).text()).appendTo(newRow); // 공급 단위

        const qtyTd = $("<td>");
        $("<input>")
            .attr("type", "number")
            .addClass("form-control form-control-sm quantity-box")
            .val(1)
            .appendTo(qtyTd);
        qtyTd.appendTo(newRow); // 수량

        $("<td>")
            .text(parseInt(itemRow.find("td").eq(6).data("price")).toLocaleString() + "원")
            .data("price", itemRow.find("td").eq(6).data("price"))
            .appendTo(newRow); // 금액

        const reasonTd = $("<td>");
        $("<input>")
            .attr("type", "text")
            .addClass("form-control form-control-sm")
            .appendTo(reasonTd);
        reasonTd.appendTo(newRow);

        const delTd = $("<td>").addClass("text-center");
        $("<button>")
            .addClass("btn btn-outline-secondary btn-sm delete-right remove-btn")
            .text("삭제")
            .appendTo(delTd);
        delTd.appendTo(newRow); // 삭제 버튼

        $("#item-proposal tbody").append(newRow);
    });

    function calcTotal(){
        const totalCnt = $("#total-cnt");
        const totalPrice = $("#total-price");

        let total = 0;
        target.children().each(function(){
            let price = $(this).find("td").eq(3).data("price");
            if (isNaN(price)) price = 0;

            total += parseInt(price); // 총 금액 계산
        });
        totalPrice
            .text(total.toLocaleString())
            .data("price", total);

        totalCnt.text($(target).children().length); // 총 품목 수
        totalCnt.data("cnt", $(target).children().length); // 총 품목 수
    }

    // 선택한 품목 최종 결산
    const target = itemProposal.find("tbody");

    const observer = new MutationObserver(function(mutations){
        mutations.forEach(m => {
            if(m.type === "childList"){
                calcTotal();
            }
        });
    });

    observer.observe(target[0], {
        childList: true,
        subtree: false
    });


    // 품목 현황 영역의 이벤트 등록
    const itemToOrder = $("#item_toOrder");

    // 재고 키워드 검색
    const searchInput = $("#search-input");
    const searchButton = $("#search-btn");

    searchButton.on("click", function(){
        const keyword = searchInput.val().trim().toLowerCase();
        const rows = itemToOrder.find("tbody tr");

        rows.each(function(){
            const code = $(this).find("td").eq(0).text().trim().toLowerCase();
            const name = $(this).find("td").eq(1).text().trim().toLowerCase();
            const category = $(this).find("td").eq(2).text().trim().toLowerCase();

            // 키워드 포함 여부 확인
            const isMatch =
                code.includes(keyword) ||
                name.includes(keyword) ||
                category.includes(keyword);

            $(this).toggle(isMatch || keyword === "");
        })
    });
    //
    // $("#store_modal").on("click", ".store_select_btn", function() {
    //     const storeName = $(this).closest("tr").find(".store_name").text();
    //     $("#selected_store").text(storeName);
    // });

    // 중복 검사
    function hasDuplicate(name) {
        return $("#item-proposal tbody tr").filter(function () {
            return $(this).find("td").eq(0).text().trim() === name;
        }).length > 0;
    }

    // 직영점 번호
    let currentStoreNo = "0";
    const storeInput = $("#storeSearchInput");
    $(document).on("click", "#storeSearchInput", function(){
        StoreSearchModal.open("", function(storeNo, storeName){
            storeInput.val(storeName);
            storeInput.data("storeno", storeNo);
            currentStoreNo = $("#storeSearchInput").data("storeno");

            fetchUtil(`/itemOrder/itemList/${storeNo}`, (data)=>{
                load_itemList(data);
            });
        });
    });
    calcTotal();


    function load_itemList(data){
        const tbody = itemToOrder.find("tbody");
        tbody.empty();

        data.forEach(item => {
            let row = `<tr data-itemno="${item.itemNo}">
                           <td>${item.itemCode}</td>
                           <td>${item.itemName}</td>
                           <td>${item.itemCategory}</td>
                           <td>${item.limit == null ? "-" : item.limit}</td>
                           <td class="text-danger fw-semibold">${item.itemQuantity == null ? "0" : item.itemQuantity}</td>
                           <td>${item.supplyUnit}</td>
                           <td data-price="${item.itemPrice}">${(item.itemPrice).toLocaleString()}</td>
                           <td class="text-center">
                           <button class="btn btn-warning btn-sm add_btn">담기</button>
                           </td>
                       </tr>`;
            tbody.append(row);
        });
    }
    function load_proposal_history(data){
        const tbody = $("#proposal_history_table tbody");
        tbody.empty();

        data.forEach((item) => {
            const date = new Date(item.proposalDate);
            let row = `<tr>
                        <td>${date.getFullYear()+"-"+String(date.getMonth()).padStart(2, "0")+"-"+String(date.getDate()).padStart(2, "0")}</td>
                        <td class="fw-bold">${item.itemName}</td>
                        <td>${item.quantity +" "+ item.supplyUnit}</td>
                        <td>${item.reason == null ? "-" : item.reason}</td>
                        <td>${item.managerName}</td>`;

            if(item.responseDate == null)
                row += `<td class="text-danger fw-bold">대기</td>`;
            else
                row += `<td class="text-success fw-bold">확인</td>`;

            tbody.append(row+`<tr>`);
        });
    }
    $(document).on("click", "#item_proposal_history", function(){
        fetchUtil(`/itemOrder/itemProposalHistory/${currentStoreNo}`, (data)=>{
            load_proposal_history(data);
        });
    });

    $(document).on("click", "#proposal-btn", function(){
        let list = {
            managerId : "galaxy0712",
            storeNo : 1,
            totalItem: $("#total-cnt").data("cnt"),
            totalPrice: $("#total-price").data("price"),
            proposalList : []
        };

        itemProposal.find("tbody tr").each(function(){
            const itemNo = $(this).data("itemno");
            const itemQuantity = $(this).find("td").eq(2).find("input").val();
            const itemOrderPrice = $(this).find("td").eq(3).data("price");
            const proposalReason = $(this).find("input").eq(1).val();
            list.proposalList.push({
                itemNo : itemNo,
                itemQuantity : itemQuantity,
                itemOrderPrice : itemOrderPrice,
                proposalReason : proposalReason
            });
        });

        fetchUtil(`/itemOrder/propose`, (data)=>{
            if(data.message === "Propose ItemOrder Success"){
                alert("성공");
                itemProposal.find("tbody").empty();
            }
        }, "POST", JSON.stringify(list));
    });
</script>
</body>
</html>
